PostgreSQL
==========

# Оглавление

- [Установка/настройка](#Установка-настройка)
    - [Установка на MacOS](#Установка-на-MacOS)
    - [Установка утилит](#Установка-утилит)
    - [Конфигурирование](#Конфигурирование)
    - [Импортирование дампа БД](#Импортирование-дампа-БД)
- [Туториалы](#Туториалы)
- [Оптимизация запросов](#Оптимизация-запросов)
- [Примеры решения задач](#Примеры-решения-задач)
    - [Запрет на созадние записей пересекающихся по времени](#Запрет-на-созадние-записей-пересекающихся-по-времени)


<a name='Установка-настройка'></a>
## Установка/настройка


<a name='Установка-на-MacOS'></a>
### Установка на MacOS

Для того, чтобы установить postgres на macos можно воспользоваться 
[PostgresApp](https://postgresapp.com). 

Данный дистрибутив представляет из себя стандартное Mac приложение. 
Всвязи с этим установка не вызовает ни каких проблем + в комплекте  
посталяется простой и удобный графический интейфейс для управления данной СУБД.


<a name='Установка-утилит'></a>
### Установка утилит

При установке дистрибутива postgres устанавливается не только сама СУБД, но 
еще и разные вспомогательные утилиты. Иногда бывает так, что сама СУБД, не 
нужна, а нужны только утилиты для работы с ней. В этом случае можно 
воспользоваться специальными пакетами, которые установят только утилиты.

**MacOS**

В MacOS установить утилиты для работы с postgres можно при помощи brew

```bash
brew install libpq
```

После установки пакета найти установленные утилиты можно в 
`/usr/local/Cellar/libpq/<версия-пакета>/bin/`.


<a name='Конфигурирование'></a>
### Конфигурирование

http://pgconfigurator.cybertec.at/ - онлайн конфигуратор postgres


<a name='Импортирование-дампа-БД'></a>
### Импортирование дампа БД

Данная иструкция проверялась обкатывалась под ubuntu, будет она
работать на других платформах или нет, не известно.

Для того, чтобы импортировать дамп базы данных, необходимо:

1. Подключиться к СУБД через оболочку

    ```bash
    sudo -u postgres psql
    ``` 

2. Создать базу данных, пользователя и дать новому пользователю права на 
   созданную БД

    ```sql
    CREATE DATABASE <db_name>;
    CREATE USER <user_name> WITH password '<you_password>';
    GRANT ALL ON DATABASE <db_name> TO <user_name>;
    ```  

3. Теперь можно выйти из оболочки, для этого введите команду `\q`. Оказавшись 
   в терминале необходимо выполнить команду:

    ```bash
    psql -h localhost -d <db_name> -U <user_name> -W -f </path/to/db_dump.sql>
    ```
    
    db_name и user_name это значения введеные Вами на предыдущем этапе.



<a name='Туториалы'></a>
## Туториалы

- https://metanit.com/sql/postgresql/1.1.php - простой и хорошо 
структуризированный манул для начинающих. Есть описание установки сервера,
примеры различных запросов и т д



<a name='Оптимизация-запросов'></a>
### Оптимизация запросов

 - [Оптимизация запросов. Основы EXPLAIN в PostgreSQL](https://m.habr.com/ru/post/203320/)
 - [Оптимизация запросов. Основы EXPLAIN в PostgreSQL (часть 2)](https://m.habr.com/ru/post/203386/)
 - [Оптимизация запросов. Основы EXPLAIN в PostgreSQL (часть 3](https://m.habr.com/ru/post/203484/)



<a name='Примеры-решения-задач'></a>
### Примеры решения задач


<a name='Запрет-на-созадние-записей-пересекающихся-по-времени'></a>
#### Запрет на созадние записей пересекающихся по времени

Данный пример показывает как можно реализовать блокировку на одновременное 
редактирование одного и тоже поста несколькими пользователями с проверкой на 
стороне БД. 

Благодаря ограничению tstzrange_constraint в таблице нельзя создать
несколько записей у которых post_id равен и значения timestamp_start_block и
timestamp_end_block пересекаются.

```sql
CREATE TABLE post (
    id SERIAL PRIMARY KEY,
    name varchar(20)
);

CREATE TABLE post_edit_block (
    id SERIAL PRIMARY KEY,
    post_id INT REFERENCES post (id),
    timestamp_start_block TIMESTAMP WITH TIME ZONE,
    timestamp_end_block TIMESTAMP WITH TIME ZONE
);

CREATE EXTENSION btree_gist;
ALTER TABLE post_edit_block
    ADD CONSTRAINT tstzrange_constraint
        EXCLUDE USING gist (
            post_id WITH =,
            tstzrange(timestamp_start_block, timestamp_end_block, '[]') WITH &&
        );
```

